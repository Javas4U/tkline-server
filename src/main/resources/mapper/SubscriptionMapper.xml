<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bytelab.tkline.server.mapper.SubscriptionMapper">

    <select id="selectNodesBySubscriptionId" resultType="com.bytelab.tkline.server.dto.node.NodeDTO">
        SELECT n.*,
               nsr.valid_from AS validFrom,
               nsr.valid_to AS validTo,
               nsr.traffic_limit AS trafficLimit,
               nsr.status AS bindingStatus
        FROM node n
        INNER JOIN node_subscription_relation nsr ON n.id = nsr.node_id
        WHERE nsr.subscription_id = #{subscriptionId}
          AND nsr.deleted = 0
          AND n.deleted = 0
          <if test="name != null and name != ''">
              AND n.name LIKE CONCAT('%', #{name}, '%')
          </if>
          <if test="region != null and region != ''">
              AND n.region LIKE CONCAT('%', #{region}, '%')
          </if>
        ORDER BY n.id DESC
    </select>

</mapper>
